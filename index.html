<!DOCTYPE html>
<!-- El atributo lang se cambiar√° din√°micamente con JS -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- El t√≠tulo tambi√©n se cambiar√° din√°micamente -->
    <title>KinoArcana: Buscador de Joyas del Cine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pop-in': 'popIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.9)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .spinner { border: 3px solid rgba(255, 255, 255, 0.1); border-radius: 50%; border-top: 3px solid #8b5cf6; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2); }
        
        .range-slider { 
            -webkit-appearance: none; 
            appearance: none; 
            background: #4b5563; /* Color de la barra vac√≠a */
            cursor: pointer; 
            width: 100%; 
            height: 6px; 
            border-radius: 3px; 
            outline: none;
            position: relative;
        }
        .range-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            appearance: none; 
            background: #a78bfa; 
            border: 2px solid #8b5cf6; 
            height: 20px; 
            width: 20px; 
            border-radius: 50%; 
            margin-top: -7px; 
        }
        .range-slider::-moz-range-thumb { 
            background: #a78bfa; 
            border: 2px solid #8b5cf6; 
            height: 20px; 
            width: 20px; 
            border-radius: 50%; 
        }

        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; border: 1px solid #4b5563; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        #quizModal { backdrop-filter: blur(10px); background-color: rgba(17, 24, 39, 0.8); }
        .answer-card { transition: all 0.2s ease-in-out; }
        .answer-card:hover { transform: scale(1.05); background-color: #4c1d95; }
        .answer-card.selected { background-color: #6d28d9; border-color: #a78bfa; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans overflow-x-hidden">

    <div id="quizModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden animate-fade-in">
        <div id="quizContainer" class="bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl max-w-2xl w-full p-8 space-y-6 animate-slide-up"></div>
        <div id="quizResultContainer" class="max-w-4xl w-full hidden"></div>
         <button id="closeQuizBtn" class="absolute top-6 right-6 text-gray-400 hover:text-white transition-colors">
            <i class="fa-solid fa-xmark fa-2x"></i>
        </button>
    </div>

    <div class="absolute top-4 right-4 z-10">
        <select id="languageSelector" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5">
            <option value="es">Espa√±ol</option>
            <option value="en">English</option>
            <option value="fr">Fran√ßais</option>
            <option value="de">Deutsch</option>
            <option value="pt">Portugu√™s</option>
        </select>
    </div>

    <div id="mainContent" class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="text-center mb-12 animate-fade-in pt-10">
            <h1 class="text-5xl md:text-6xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500" data-lang-key="appTitle">KinoArcana</h1>
            <p class="text-xl text-gray-300 max-w-3xl mx-auto" data-lang-key="appSubtitle">Descubre las obras maestras que el algoritmo olvid√≥.</p>
        </header>

        <section class="mb-12">
            <div class="bg-gray-800 rounded-xl p-6 shadow-xl border border-gray-700">
                <form id="filterForm" class="space-y-6">
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div>
                            <label for="contentType" class="block text-sm font-medium mb-2 text-gray-300" data-lang-key="filterType">Tipo</label>
                            <select id="contentType" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 transition-all">
                                <option value="movie" data-lang-key="filterTypeMovie">üé• Pel√≠culas</option>
                                <option value="tv" data-lang-key="filterTypeTV">üì∫ Series de TV</option>
                            </select>
                        </div>
                        <div>
                            <label for="genre" class="block text-sm font-medium mb-2 text-gray-300" data-lang-key="filterGenre">G√©nero</label>
                            <select id="genre" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 transition-all">
                                <option value="" data-lang-key="filterGenreAll">Todos</option>
                            </select>
                        </div>
                        <div>
                            <label for="sortBy" class="block text-sm font-medium mb-2 text-gray-300" data-lang-key="filterSortBy">Ordenar Por</label>
                            <select id="sortBy" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 transition-all">
                                <option value="popularity.desc" data-lang-key="filterSortPopularity">Popularidad</option>
                                <option value="vote_average.desc" data-lang-key="filterSortRating">Mejor Puntuaci√≥n</option>
                                <option value="release_date.desc" data-lang-key="filterSortNewest">M√°s Recientes</option>
                                <option value="revenue.desc" data-lang-key="filterSortRevenue">Mayores Ingresos</option>
                                <option value="vote_count.desc" data-lang-key="filterSortVotes">M√°s Votadas</option>
                            </select>
                        </div>
                         <div>
                            <label for="language" class="block text-sm font-medium mb-2 text-gray-300">
                                <span data-lang-key="filterLanguage">Idioma Original</span>
                                <span class="tooltip"><i class="fa-solid fa-circle-info text-gray-400"></i><span class="tooltiptext" data-lang-key="filterLanguageTooltip">Usa c√≥digos ISO 639-1. Ej: 'ja' para japon√©s, 'es' para espa√±ol, 'ko' para coreano.</span></span>
                            </label>
                            <input type="text" id="language" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 transition-all" placeholder="Ej: ja, ko, es...">
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-700 pt-6 space-y-8">
                        <div>
                            <label class="block text-sm font-medium mb-3 text-gray-300"><span data-lang-key="filterYear">A√±o de Lanzamiento</span>: <span id="yearRangeLabel" class="text-purple-400 font-bold">1980 - 2025</span></label>
                            <div class="flex items-center gap-4">
                                <div class="flex-1">
                                    <input type="range" id="startYear" min="1900" max="2025" value="1980" class="w-full range-slider">
                                    <div id="startYearValue" class="text-center text-xs text-gray-400 mt-1">1980</div>
                                </div>
                                <span class="text-gray-500 font-bold">-</span>
                                <div class="flex-1">
                                    <input type="range" id="endYear" min="1900" max="2025" value="2025" class="w-full range-slider">
                                    <div id="endYearValue" class="text-center text-xs text-gray-400 mt-1">2025</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-3 text-gray-300"><span data-lang-key="filterRating">Puntuaci√≥n</span>: <span id="ratingRangeLabel" class="text-purple-400 font-bold">7.0 - 10</span></label>
                            <div class="flex items-center gap-4">
                                <div class="flex-1">
                                    <input type="range" id="startRating" min="0" max="10" step="0.1" value="7.0" class="w-full range-slider">
                                    <div id="startRatingValue" class="text-center text-xs text-gray-400 mt-1">7.0</div>
                                </div>
                                <span class="text-gray-500 font-bold">-</span>
                                <div class="flex-1">
                                    <input type="range" id="endRating" min="0" max="10" step="0.1" value="10" class="w-full range-slider">
                                    <div id="endRatingValue" class="text-center text-xs text-gray-400 mt-1">10</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-3 text-gray-300">
                                <span data-lang-key="filterVoteCount">Cantidad de Votos</span>
                                <span class="tooltip"><i class="fa-solid fa-circle-info text-gray-400"></i><span class="tooltiptext" data-lang-key="filterVoteCountTooltip">Usa un rango bajo para encontrar joyas ocultas, o un rango alto para encontrar cl√°sicos aclamados.</span></span>
                                : <span id="voteCountRangeLabel" class="text-purple-400 font-bold">100 - 1500</span>
                            </label>
                             <div class="flex items-center gap-4">
                                <div class="flex-1">
                                    <input type="range" id="startVoteCount" min="0" max="10000" step="50" value="100" class="w-full range-slider">
                                    <div id="startVoteCountValue" class="text-center text-xs text-gray-400 mt-1">100</div>
                                </div>
                                <span class="text-gray-500 font-bold">-</span>
                                <div class="flex-1">
                                    <input type="range" id="endVoteCount" min="0" max="10000" step="50" value="1500" class="w-full range-slider">
                                    <div id="endVoteCountValue" class="text-center text-xs text-gray-400 mt-1">1500</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row items-center justify-center gap-4 pt-4">
                        <button type="button" id="magicQuizBtn" class="w-full md:w-auto bg-gradient-to-r from-teal-400 to-blue-500 hover:opacity-90 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> <span data-lang-key="btnMagicQuiz">Gu√≠a M√°gica</span>
                        </button>
                        <button type="button" id="hiddenGemsPreset" class="w-full md:w-auto bg-gradient-to-r from-yellow-500 to-orange-500 hover:opacity-90 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg">
                            <i class="fa-solid fa-star"></i> <span data-lang-key="btnFindGems">Joyas Ocultas</span>
                        </button>
                        <button type="submit" class="w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg">
                            <i class="fa-solid fa-search"></i> <span data-lang-key="btnSearch">Buscar</span>
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <main>
            <div id="statusContainer" class="text-center py-12"></div>
            <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS & DICTIONARY ---
            const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';
            const translations = {
                es: { docTitle: "KinoArcana: Buscador de Joyas del Cine", appTitle: "KinoArcana", appSubtitle: "Descubre las obras maestras que el algoritmo olvid√≥.", filterType: "Tipo", filterTypeMovie: "üé• Pel√≠culas", filterTypeTV: "üì∫ Series de TV", filterGenre: "G√©nero", filterGenreAll: "Todos", filterSortBy: "Ordenar Por", filterSortPopularity: "Popularidad", filterSortRating: "Mejor Puntuaci√≥n", filterSortNewest: "M√°s Recientes", filterSortRevenue: "Mayores Ingresos", filterSortVotes: "M√°s Votadas", filterLanguage: "Idioma Original", filterLanguageTooltip: "Usa c√≥digos ISO 639-1. Ej: 'ja' para japon√©s, 'es' para espa√±ol, 'ko' para coreano.", filterYear: "A√±o de Lanzamiento", filterRating: "Puntuaci√≥n", filterVoteCount: "Cantidad de Votos", filterVoteCountTooltip: "Usa un rango bajo para encontrar joyas ocultas, o un rango alto para encontrar cl√°sicos aclamados.", btnMagicQuiz: "Gu√≠a M√°gica", btnFindGems: "Joyas Ocultas", btnSearch: "Buscar", statusLoading: "Buscando el mejor contenido...", statusNoResults: "No se encontraron resultados", statusNoResultsSub: "Prueba con filtros m√°s amplios.", statusError: "Ocurri√≥ un error", statusErrorVercel: "Esta aplicaci√≥n es avanzada y debe publicarse en un servidor para funcionar. ¬°Sigue la gu√≠a de Vercel para ponerla en l√≠nea gratis!", statusErrorGenres: "No se pudieron cargar los g√©neros. Aseg√∫rate de que el backend est√° funcionando y la API Key es correcta.", statusErrorSearch: "Error al realizar la b√∫squeda:", cardVotes: "votos", quizStep: "Paso {current} de {total}", quizSearching: "Buscando la joya perfecta para ti...", quizNoResult: "¬°Vaya! No encontramos una joya.", quizNoResultSub: "A veces, los tesoros m√°s raros son dif√≠ciles de encontrar. ¬°Int√©ntalo de nuevo!", quizRetry: "Intentar de Nuevo", resultTitle: "Tu recomendaci√≥n m√°gica es...", noOverviewText: "No hay una descripci√≥n disponible en este idioma." },
                en: { docTitle: "KinoArcana: Hidden Gems Finder", appTitle: "KinoArcana", appSubtitle: "Discover the masterpieces the algorithm forgot.", filterType: "Type", filterTypeMovie: "üé• Movies", filterTypeTV: "üì∫ TV Series", filterGenre: "Genre", filterGenreAll: "All", filterSortBy: "Sort By", filterSortPopularity: "Popularity", filterSortRating: "Top Rated", filterSortNewest: "Newest", filterSortRevenue: "Highest Revenue", filterSortVotes: "Most Voted", filterLanguage: "Original Language", filterLanguageTooltip: "Use ISO 639-1 codes. E.g., 'ja' for Japanese, 'en' for English, 'ko' for Korean.", filterYear: "Release Year", filterRating: "Rating", filterVoteCount: "Vote Count", filterVoteCountTooltip: "Use a low range to find hidden gems, or a high range to find acclaimed classics.", btnMagicQuiz: "Magic Guide", btnFindGems: "Hidden Gems", btnSearch: "Search", statusLoading: "Searching for the best content...", statusNoResults: "No results found", statusNoResultsSub: "Try using broader filters.", statusError: "An error occurred", statusErrorVercel: "This is an advanced application and must be deployed to a server to work. Follow the Vercel guide to get it online for free!", statusErrorGenres: "Could not load genres. Make sure the backend is running and the API Key is correct.", statusErrorSearch: "Error during search:", cardVotes: "votes", quizStep: "Step {current} of {total}", quizSearching: "Searching for the perfect gem for you...", quizNoResult: "Oops! We couldn't find a gem.", quizNoResultSub: "Sometimes, the rarest treasures are hard to find. Please try again!", quizRetry: "Try Again", resultTitle: "Your magic recommendation is...", noOverviewText: "No overview is available in this language." },
                fr: { docTitle: "KinoArcana: Chercheur de P√©pites", appTitle: "KinoArcana", appSubtitle: "D√©couvrez les chefs-d'≈ìuvre que l'algorithme a oubli√©s.", filterType: "Type", filterTypeMovie: "üé• Films", filterTypeTV: "üì∫ S√©ries TV", filterGenre: "Genre", filterGenreAll: "Tous", filterSortBy: "Trier par", filterSortPopularity: "Popularit√©", filterSortRating: "Mieux not√©s", filterSortNewest: "Plus r√©cents", filterSortRevenue: "Revenus les plus √©lev√©s", filterSortVotes: "Plus vot√©s", filterLanguage: "Langue originale", filterLanguageTooltip: "Utilisez les codes ISO 639-1. Ex: 'ja' pour japonais, 'fr' pour fran√ßais, 'ko' pour cor√©en.", filterYear: "Ann√©e de sortie", filterRating: "Note", filterVoteCount: "Nombre de votes", filterVoteCountTooltip: "Utilisez une plage basse pour trouver des p√©pites, ou une plage √©lev√©e pour les classiques.", btnMagicQuiz: "Guide Magique", btnFindGems: "P√©pites Cach√©es", btnSearch: "Rechercher", statusLoading: "Recherche du meilleur contenu...", statusNoResults: "Aucun r√©sultat trouv√©", statusNoResultsSub: "Essayez avec des filtres plus larges.", statusError: "Une erreur est survenue", statusErrorVercel: "Cette application avanc√©e doit √™tre d√©ploy√©e sur un serveur. Suivez le guide Vercel pour la mettre en ligne gratuitement !", statusErrorGenres: "Impossible de charger les genres. V√©rifiez que le backend fonctionne et que la cl√© API est correcte.", statusErrorSearch: "Erreur lors de la recherche :", cardVotes: "votes", quizStep: "√âtape {current} sur {total}", quizSearching: "Recherche de la perle rare pour vous...", quizNoResult: "Oups! Nous n'avons pas trouv√© de p√©pite.", quizNoResultSub: "Parfois, les tr√©sors les plus rares sont difficiles √† trouver. R√©essayez !", quizRetry: "R√©essayer", resultTitle: "Votre recommandation magique est...", noOverviewText: "Aucune description n'est disponible dans cette langue." },
                de: { docTitle: "KinoArcana: Finder f√ºr verborgene Sch√§tze", appTitle: "KinoArcana", appSubtitle: "Entdecke die Meisterwerke, die der Algorithmus vergessen hat.", filterType: "Typ", filterTypeMovie: "üé• Filme", filterTypeTV: "üì∫ Fernsehserien", filterGenre: "Genre", filterGenreAll: "Alle", filterSortBy: "Sortieren nach", filterSortPopularity: "Popularit√§t", filterSortRating: "Bestbewertet", filterSortNewest: "Neueste", filterSortRevenue: "H√∂chster Umsatz", filterSortVotes: "Meistbewertet", filterLanguage: "Originalsprache", filterLanguageTooltip: "Verwenden Sie ISO 639-1-Codes. Z.B. 'ja' f√ºr Japanisch, 'de' f√ºr Deutsch, 'ko' f√ºr Koreanisch.", filterYear: "Ver√∂ffentlichungsjahr", filterRating: "Bewertung", filterVoteCount: "Anzahl der Stimmen", filterVoteCountTooltip: "Verwenden Sie einen niedrigen Bereich f√ºr verborgene Sch√§tze oder einen hohen Bereich f√ºr Klassiker.", btnMagicQuiz: "Magischer F√ºhrer", btnFindGems: "Verborgene Sch√§tze", btnSearch: "Suchen", statusLoading: "Suche nach den besten Inhalten...", statusNoResults: "Keine Ergebnisse gefunden", statusNoResultsSub: "Versuchen Sie es mit breiteren Filtern.", statusError: "Ein Fehler ist aufgetreten", statusErrorVercel: "Diese Anwendung muss auf einem Server bereitgestellt werden. Folgen Sie der Vercel-Anleitung, um sie kostenlos online zu stellen!", statusErrorGenres: "Genres konnten nicht geladen werden. Stellen Sie sicher, dass das Backend l√§uft und der API-Schl√ºssel korrekt ist.", statusErrorSearch: "Fehler bei der Suche:", cardVotes: "Stimmen", quizStep: "Schritt {current} von {total}", quizSearching: "Suche nach dem perfekten Juwel f√ºr dich...", quizNoResult: "Hoppla! Wir konnten keinen Schatz finden.", quizNoResultSub: "Manchmal sind die seltensten Sch√§tze schwer zu finden. Bitte versuch es erneut!", quizRetry: "Erneut versuchen", resultTitle: "Deine magische Empfehlung lautet...", noOverviewText: "In dieser Sprache ist keine √úbersicht verf√ºgbar." },
                pt: { docTitle: "KinoArcana: Ca√ßador de Joias Escondidas", appTitle: "KinoArcana", appSubtitle: "Descubra as obras-primas que o algoritmo esqueceu.", filterType: "Tipo", filterTypeMovie: "üé• Filmes", filterTypeTV: "üì∫ S√©ries de TV", filterGenre: "G√™nero", filterGenreAll: "Todos", filterSortBy: "Ordenar por", filterSortPopularity: "Popularidade", filterSortRating: "Mais bem avaliados", filterSortNewest: "Mais recentes", filterSortRevenue: "Maior receita", filterSortVotes: "Mais votados", filterLanguage: "Idioma original", filterLanguageTooltip: "Use c√≥digos ISO 639-1. Ex: 'ja' para japon√™s, 'pt' para portugu√™s, 'ko' para coreano.", filterYear: "Ano de lan√ßamento", filterRating: "Avalia√ß√£o", filterVoteCount: "Contagem de votos", filterVoteCountTooltip: "Use um intervalo baixo para encontrar joias escondidas ou um intervalo alto para cl√°ssicos.", btnMagicQuiz: "Guia M√°gico", btnFindGems: "Joias Escondidas", btnSearch: "Pesquisar", statusLoading: "Procurando o melhor conte√∫do...", statusNoResults: "Nenhum resultado encontrado", statusNoResultsSub: "Tente usar filtros mais amplos.", statusError: "Ocorreu um erro", statusErrorVercel: "Esta aplica√ß√£o avan√ßada deve ser implantada em um servidor. Siga o guia Vercel para coloc√°-la online de gra√ßa!", statusErrorGenres: "N√£o foi poss√≠vel carregar os g√™neros. Certifique-se de que o backend est√° funcionando e a chave da API est√° correta.", statusErrorSearch: "Erro durante a pesquisa:", cardVotes: "votos", quizStep: "Passo {current} de {total}", quizSearching: "Procurando a joia perfeita para voc√™...", quizNoResult: "Ops! N√£o conseguimos encontrar uma joia.", quizNoResultSub: "√Äs vezes, os tesouros mais raros s√£o dif√≠ceis de encontrar. Por favor, tente novamente!", quizRetry: "Tentar Novamente", resultTitle: "Sua recomenda√ß√£o m√°gica √©...", noOverviewText: "Nenhuma sinopse dispon√≠vel neste idioma." }
            };
            const quizData = {
                es: [ { stepText: "Paso {current} de {total}", question: "¬øQu√© tipo de historia te apetece hoy?", searchingText: "Buscando la joya perfecta para ti...", noResultText: "¬°Vaya! No encontramos una joya.", noResultSubtext: "A veces, los tesoros m√°s raros son dif√≠ciles de encontrar. ¬°Int√©ntalo de nuevo!", retryText: "Intentar de Nuevo", resultTitle: "Tu recomendaci√≥n m√°gica es...", noOverviewText: "No hay una descripci√≥n disponible en este idioma.", answers: [ { text: "Algo que me haga pensar", icon: "fa-brain", params: { with_genres: "99,18" } }, { text: "Una aventura √©pica", icon: "fa-dungeon", params: { with_genres: "12,14,878" } }, { text: "Risas y buen rollo", icon: "fa-face-laugh-beam", params: { with_genres: "35,10751" } }, { text: "Misterio y tensi√≥n", icon: "fa-user-secret", params: { with_genres: "9648,53,80" } } ] }, { stepText: "Paso {current} de {total}", question: "¬øPrefieres una historia del mundo real o algo fant√°stico?", answers: [ { text: "Basado en la realidad", icon: "fa-landmark", params: { with_keywords: "9715" } }, { text: "Pura imaginaci√≥n", icon: "fa-wand-magic-sparkles", params: { without_keywords: "9715" } } ] }, { stepText: "Paso {current} de {total}", question: "¬øTe apetece un cl√°sico o algo m√°s moderno?", answers: [ { text: "Un cl√°sico atemporal (antes del 2000)", icon: "fa-film", params: { 'primary_release_date.lte': '1999-12-31' } }, { text: "Algo fresco y nuevo (despu√©s del 2000)", icon: "fa-mobile-screen-button", params: { 'primary_release_date.gte': '2000-01-01' } } ] } ],
            };
            ['en', 'fr', 'de', 'pt'].forEach(lang => { quizData[lang] = quizData.es; });
            let currentLang = 'es';

            const dom = { html: document.documentElement, languageSelector: document.getElementById('languageSelector'), filterForm: document.getElementById('filterForm'), contentType: document.getElementById('contentType'), genre: document.getElementById('genre'), sortBy: document.getElementById('sortBy'), language: document.getElementById('language'), startYear: document.getElementById('startYear'), endYear: document.getElementById('endYear'), yearRangeLabel: document.getElementById('yearRangeLabel'), startRating: document.getElementById('startRating'), endRating: document.getElementById('endRating'), ratingRangeLabel: document.getElementById('ratingRangeLabel'), startVoteCount: document.getElementById('startVoteCount'), endVoteCount: document.getElementById('endVoteCount'), voteCountRangeLabel: document.getElementById('voteCountRangeLabel'), startYearValue: document.getElementById('startYearValue'), endYearValue: document.getElementById('endYearValue'), startRatingValue: document.getElementById('startRatingValue'), endRatingValue: document.getElementById('endRatingValue'), startVoteCountValue: document.getElementById('startVoteCountValue'), endVoteCountValue: document.getElementById('endVoteCountValue'), hiddenGemsPresetBtn: document.getElementById('hiddenGemsPreset'), statusContainer: document.getElementById('statusContainer'), resultsGrid: document.getElementById('resultsGrid'), quizModal: document.getElementById('quizModal'), quizContainer: document.getElementById('quizContainer'), quizResultContainer: document.getElementById('quizResultContainer'), magicQuizBtn: document.getElementById('magicQuizBtn'), closeQuizBtn: document.getElementById('closeQuizBtn'), };
            
            // --- FIX START ---
            // Helper function to detect if the app is running in a local/preview environment
            const isDevEnvironment = () => !window.location.hostname.includes('vercel.app') && !window.location.hostname.includes('localhost');
            // --- FIX END ---
            
            let quizCurrentStep = 0;
            let quizSelectedParams = {};
            const startQuiz = () => { quizCurrentStep = 0; quizSelectedParams = {}; dom.quizContainer.classList.remove('hidden'); dom.quizResultContainer.classList.add('hidden'); dom.quizModal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; renderQuizStep(); };
            const closeQuiz = () => { dom.quizModal.classList.add('hidden'); document.body.style.overflow = ''; };
            const renderQuizStep = () => { const stepData = quizData[currentLang][quizCurrentStep]; let answersHtml = stepData.answers.map((answer, index) => ` <div class="answer-card bg-gray-700 border-2 border-transparent p-4 rounded-lg cursor-pointer flex items-center gap-4" data-answer-index="${index}"> <i class="fa-solid ${answer.icon} fa-2x w-8 text-center text-purple-300"></i> <span class="font-semibold">${answer.text}</span> </div> `).join(''); const stepText = translations[currentLang].quizStep .replace('{current}', quizCurrentStep + 1) .replace('{total}', quizData[currentLang].length); dom.quizContainer.innerHTML = ` <div class="text-center mb-2"> <span class="text-purple-400 font-semibold">${stepText}</span> </div> <h2 class="text-2xl font-bold text-center mb-6">${stepData.question}</h2> <div class="space-y-4">${answersHtml}</div> `; dom.quizContainer.querySelectorAll('.answer-card').forEach(card => { card.addEventListener('click', () => selectAnswer(card.dataset.answerIndex)); }); };
            const selectAnswer = (index) => { const stepData = quizData[currentLang][quizCurrentStep]; const answer = stepData.answers[index]; Object.assign(quizSelectedParams, answer.params); quizCurrentStep++; if (quizCurrentStep < quizData[currentLang].length) { renderQuizStep(); } else { endQuiz(); } };
            const endQuiz = async () => { 
                // --- FIX START ---
                if (isDevEnvironment()) {
                    renderQuizResult(null, new Error("Dev environment"));
                    return;
                }
                // --- FIX END ---
                dom.quizContainer.innerHTML = `<div class="text-center p-8"><div class="spinner mx-auto"></div><p class="mt-4 text-gray-300">${translations[currentLang].quizSearching}</p></div>`; const params = new URLSearchParams({ contentType: 'movie', sortBy: 'vote_average.desc', 'vote_count.gte': 100, 'vote_count.lte': 2500, ...quizSelectedParams, language: currentLang }); try { const response = await fetch(`/api/discover?${params}`); if (!response.ok) throw new Error('API response failed'); const data = await response.json(); const validResults = data.results.filter(r => r.poster_path && r.overview); const result = validResults.length > 0 ? validResults[Math.floor(Math.random() * Math.min(10, validResults.length))] : null; renderQuizResult(result); } catch (error) { renderQuizResult(null, error); } };
            const renderQuizResult = (result, error = null) => { 
                // --- FIX START ---
                if (error && error.message === "Dev environment") {
                    dom.quizResultContainer.innerHTML = `<div class="bg-gray-800 border border-gray-700 rounded-2xl p-8 text-center animate-pop-in"><div class="text-6xl mb-4">üöÄ</div><h3 class="text-2xl font-bold mb-2">${translations[currentLang].statusError}</h3><p class="text-gray-400 mb-6">${translations[currentLang].statusErrorVercel}</p><button id="retryQuizBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fa-solid fa-rotate-right"></i> ${translations[currentLang].quizRetry}</button></div>`;
                    dom.quizContainer.classList.add('hidden');
                    dom.quizResultContainer.classList.remove('hidden');
                    dom.quizResultContainer.querySelector('#retryQuizBtn').addEventListener('click', startQuiz);
                    return;
                }
                 // --- FIX END ---
                const lang = translations[currentLang]; if (error || !result) { dom.quizResultContainer.innerHTML = ` <div class="bg-gray-800 border border-gray-700 rounded-2xl p-8 text-center animate-pop-in"> <div class="text-6xl mb-4">ü§∑</div> <h3 class="text-2xl font-bold mb-2">${lang.quizNoResult}</h3> <p class="text-gray-400 mb-6">${lang.quizNoResultSub}</p> <button id="retryQuizBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fa-solid fa-rotate-right"></i> ${lang.quizRetry}</button> </div>`; } else { const posterPath = `${IMAGE_BASE_URL}${result.poster_path}`; const year = (result.release_date || 'N/A').split('-')[0]; dom.quizResultContainer.innerHTML = ` <div class="bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl w-full animate-pop-in grid md:grid-cols-3 gap-8 p-8"> <div class="md:col-span-1"><img src="${posterPath}" alt="${result.title}" class="rounded-lg shadow-xl w-full"></div> <div class="md:col-span-2 space-y-4"> <div> <span class="text-purple-400 font-semibold">${lang.resultTitle}</span> <h2 class="text-4xl font-bold">${result.title} (${year})</h2> </div> <div class="flex items-center gap-4 text-lg"> <span class="flex items-center gap-2"><i class="fa-solid fa-star text-yellow-400"></i> ${result.vote_average.toFixed(1)}</span> <span class="text-gray-400">|</span> <span class="flex items-center gap-2"><i class="fa-solid fa-users text-gray-400"></i> ${result.vote_count} ${lang.cardVotes}</span> </div> <p class="text-gray-300 line-clamp-6">${result.overview || lang.noOverviewText}</p> <div class="pt-4"><button id="retryQuizBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fa-solid fa-rotate-right"></i> ${lang.quizRetry}</button></div> </div> </div>`; } dom.quizContainer.classList.add('hidden'); dom.quizResultContainer.classList.remove('hidden'); dom.quizResultContainer.querySelector('#retryQuizBtn').addEventListener('click', startQuiz); };
            
            const getInitialLanguage = () => { const savedLang = localStorage.getItem('kinoArcanaLang'); return savedLang && translations[savedLang] ? savedLang : 'es'; };
            const setLanguage = (lang) => { if (!translations[lang]) return; currentLang = lang; localStorage.setItem('kinoArcanaLang', lang); dom.html.lang = lang; document.title = translations[lang].docTitle; document.querySelectorAll('[data-lang-key]').forEach(el => { const key = el.dataset.langKey; if (translations[lang][key]) { el.textContent = translations[lang][key]; } }); loadGenres(); };
            
            async function loadGenres() { 
                // --- FIX START ---
                if (isDevEnvironment()) {
                    return updateStatus('error');
                }
                // --- FIX END ---
                try { const response = await fetch(`/api/genres?contentType=${dom.contentType.value}&language=${currentLang}`); if (!response.ok) throw new Error('API response failed'); const data = await response.json(); const lang = translations[currentLang]; dom.genre.innerHTML = `<option value="">${lang.filterGenreAll}</option>`; data.genres.forEach(genre => { dom.genre.innerHTML += `<option value="${genre.id}">${genre.name}</option>`; }); } catch(e) { console.error(e); updateStatus('error', translations[currentLang].statusErrorGenres); } }
            
            async function handleSearch(e) { 
                e.preventDefault(); 
                // --- FIX START ---
                if (isDevEnvironment()) {
                    return updateStatus('error');
                }
                // --- FIX END ---
                dom.resultsGrid.innerHTML = ''; updateStatus('loading'); const params = new URLSearchParams({ contentType: dom.contentType.value, sortBy: dom.sortBy.value, genre: dom.genre.value, originalLanguage: dom.language.value.trim(), startYear: dom.startYear.value, endYear: dom.endYear.value, startRating: dom.startRating.value, endRating: dom.endRating.value, startVoteCount: dom.startVoteCount.value, endVoteCount: dom.endVoteCount.value, language: currentLang }); try { const response = await fetch(`/api/discover?${params}`); if (!response.ok) throw new Error(await response.text()); const data = await response.json(); displayResults(data.results); } catch (error) { console.error('Error during search:', error); updateStatus('error', `${translations[currentLang].statusErrorSearch} ${error.message}`); } }
            
            const updateSliderTrack = (slider) => { const min = slider.min; const max = slider.max; const val = slider.value; const percentage = ((val - min) / (max - min)) * 100; slider.style.background = `linear-gradient(to right, #8b5cf6 ${percentage}%, #4b5563 ${percentage}%)`; };
            const updateRangeLabel = (labelElem, startElem, endElem, startValueElem, endValueElem, decimals = 0) => () => { let start = parseFloat(startElem.value); let end = parseFloat(endElem.value); if (start > end) { [start, end] = [end, start]; startElem.value = start; endElem.value = end; } labelElem.textContent = `${start.toFixed(decimals)} - ${end.toFixed(decimals)}`; startValueElem.textContent = start.toFixed(decimals); endValueElem.textContent = end.toFixed(decimals); };
            
            const updateStatus = (type, message = '') => { const lang = translations[currentLang]; let content = ''; switch (type) { case 'loading': content = `<div class="spinner mx-auto"></div><p class="mt-4 text-gray-300">${lang.statusLoading}</p>`; break; case 'no-results': content = `<div class="text-6xl mb-4">ü§∑</div><h3 class="text-xl font-semibold">${lang.statusNoResults}</h3><p class="text-gray-300">${lang.statusNoResultsSub}</p>`; break; case 'error': 
                // --- FIX START ---
                const isDev = isDevEnvironment();
                // --- FIX END ---
                const finalMessage = isDev ? lang.statusErrorVercel : message; content = `<div class="text-6xl mb-4">‚ö†Ô∏è</div><h3 class="text-xl font-semibold">${lang.statusError}</h3><p class="text-gray-300">${finalMessage}</p>`; break; } dom.statusContainer.innerHTML = content; };
            
            const displayResults = (results) => { dom.statusContainer.innerHTML = ''; if (results.length === 0) return updateStatus('no-results'); results.forEach(item => { const card = createResultCard(item); dom.resultsGrid.appendChild(card); }); };
            const createResultCard = (item) => { const card = document.createElement('div'); card.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg card-hover animate-fade-in'; const title = item.title || item.name; const year = (item.release_date || item.first_air_date || 'N/A').split('-')[0]; const posterPath = item.poster_path ? `${IMAGE_BASE_URL}${item.poster_path}` : 'https://placehold.co/500x750/1f2937/4b5563?text=Sin+Imagen'; card.innerHTML = ` <div class="relative aspect-[2/3] bg-gray-700"> <img src="${posterPath}" alt="${title}" class="w-full h-full object-cover" loading="lazy"> <div class="absolute top-2 right-2 bg-black bg-opacity-70 px-2 py-1 rounded-full flex items-center text-xs"> <i class="fa-solid fa-star text-yellow-400 mr-1"></i> <span class="font-bold">${item.vote_average.toFixed(1)}</span> </div> </div> <div class="p-4"> <h3 class="font-semibold text-white mb-1 line-clamp-2">${title}</h3> <div class="text-gray-400 text-sm flex justify-between items-center"> <span>${year}</span> <span class="flex items-center" title="${item.vote_count} votos"> <i class="fa-solid fa-users mr-1"></i> ${item.vote_count} </span> </div> </div>`; return card; };
            const applyHiddenGemsPreset = () => { dom.sortBy.value = 'vote_average.desc'; dom.startRating.value = 7.5; dom.endRating.value = 10; dom.startVoteCount.value = 50; dom.endVoteCount.value = 1500; dom.startYear.value = 1970; dom.endYear.value = 2020; document.querySelectorAll('.range-slider').forEach(slider => updateSliderTrack(slider)); updateRangeLabel(dom.ratingRangeLabel, dom.startRating, dom.endRating, dom.startRatingValue, dom.endRatingValue, 1)(); updateRangeLabel(dom.voteCountRangeLabel, dom.startVoteCount, dom.endVoteCount, dom.startVoteCountValue, dom.endVoteCountValue)(); updateRangeLabel(dom.yearRangeLabel, dom.startYear, dom.endYear, dom.startYearValue, dom.endYearValue)(); dom.filterForm.requestSubmit(); };

            const setupEventListeners = () => {
                dom.languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));
                dom.filterForm.addEventListener('submit', handleSearch);
                dom.contentType.addEventListener('change', loadGenres);
                dom.hiddenGemsPresetBtn.addEventListener('click', applyHiddenGemsPreset);
                
                ['startYear', 'endYear', 'startRating', 'endRating', 'startVoteCount', 'endVoteCount'].forEach(id => {
                    dom[id].addEventListener('input', () => {
                        updateRangeLabel(dom.yearRangeLabel, dom.startYear, dom.endYear, dom.startYearValue, dom.endYearValue)();
                        updateRangeLabel(dom.ratingRangeLabel, dom.startRating, dom.endRating, dom.startRatingValue, dom.endRatingValue, 1)();
                        updateRangeLabel(dom.voteCountRangeLabel, dom.startVoteCount, dom.endVoteCount, dom.startVoteCountValue, dom.endVoteCountValue)();
                    });
                });
                
                document.querySelectorAll('.range-slider').forEach(slider => slider.addEventListener('input', () => updateSliderTrack(slider)));
                
                dom.magicQuizBtn.addEventListener('click', startQuiz);
                dom.closeQuizBtn.addEventListener('click', closeQuiz);
            };

            const init = () => {
                const initLang = getInitialLanguage();
                dom.languageSelector.value = initLang;
                setLanguage(initLang);
                setupEventListeners();
                
                updateRangeLabel(dom.yearRangeLabel, dom.startYear, dom.endYear, dom.startYearValue, dom.endYearValue)();
                updateRangeLabel(dom.ratingRangeLabel, dom.startRating, dom.endRating, dom.startRatingValue, dom.endRatingValue, 1)();
                updateRangeLabel(dom.voteCountRangeLabel, dom.startVoteCount, dom.endVoteCount, dom.startVoteCountValue, dom.endVoteCountValue)();
                document.querySelectorAll('.range-slider').forEach(slider => updateSliderTrack(slider));
            };

            init();
        });
    </script>
</body>
</html>

