<!DOCTYPE html>
<!-- El atributo lang se cambiar√° din√°micamente con JS -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- El t√≠tulo tambi√©n se cambiar√° din√°micamente -->
    <title>KinoArcana: Buscador de Joyas del Cine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        .spinner { border: 3px solid rgba(255, 255, 255, 0.1); border-radius: 50%; border-top: 3px solid #8b5cf6; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2); }
        .range-slider { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; }
        .range-slider::-webkit-slider-track { background: #374151; height: 6px; border-radius: 3px; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; background: #8b5cf6; height: 20px; width: 20px; border-radius: 50%; margin-top: -7px; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; border: 1px solid #4b5563; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">

    <!-- Selector de Idioma -->
    <div class="absolute top-4 right-4 z-10">
        <select id="languageSelector" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5">
            <option value="es">Espa√±ol</option>
            <option value="en">English</option>
            <option value="fr">Fran√ßais</option>
            <option value="de">Deutsch</option>
            <option value="pt">Portugu√™s</option>
        </select>
    </div>

    <!-- Contenido Principal -->
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="text-center mb-12 animate-fade-in pt-10">
            <h1 class="text-5xl md:text-6xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500" data-lang-key="appTitle">KinoArcana</h1>
            <p class="text-xl text-gray-300 max-w-3xl mx-auto" data-lang-key="appSubtitle">Descubre las obras maestras que el algoritmo olvid√≥.</p>
        </header>

        <!-- Panel de Filtros -->
        <section class="mb-12">
            <div class="bg-gray-800 rounded-xl p-6 shadow-xl border border-gray-700">
                <form id="filterForm" class="space-y-6">
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Basic Filters -->
                        <div>
                            <label for="contentType" class="block text-sm font-medium mb-2 text-gray-300" data-lang-key="filterType">Tipo</label>
                            <select id="contentType" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 transition-all">
                                <option value="movie" data-lang-key="filterTypeMovie">üé• Pel√≠culas</option>
                                <option value="tv" data-lang-key="filterTypeTV">üì∫ Series de TV</option>
                            </select>
                        </div>
                        <div>
                            <label for="genre" class="block text-sm font-medium mb-2 text-gray-300" data-lang-key="filterGenre">G√©nero</label>
                            <select id="genre" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 transition-all">
                                <option value="" data-lang-key="filterGenreAll">Todos</option>
                            </select>
                        </div>
                        <div>
                            <label for="sortBy" class="block text-sm font-medium mb-2 text-gray-300" data-lang-key="filterSortBy">Ordenar Por</label>
                            <select id="sortBy" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 transition-all">
                                <option value="popularity.desc" data-lang-key="filterSortPopularity">Popularidad</option>
                                <option value="vote_average.desc" data-lang-key="filterSortRating">Mejor Puntuaci√≥n</option>
                                <option value="release_date.desc" data-lang-key="filterSortNewest">M√°s Recientes</option>
                                <option value="revenue.desc" data-lang-key="filterSortRevenue">Mayores Ingresos</option>
                                <option value="vote_count.desc" data-lang-key="filterSortVotes">M√°s Votadas</option>
                            </select>
                        </div>
                         <div>
                            <label for="language" class="block text-sm font-medium mb-2 text-gray-300">
                                <span data-lang-key="filterLanguage">Idioma Original</span>
                                <span class="tooltip"><i class="fa-solid fa-circle-info text-gray-400"></i><span class="tooltiptext" data-lang-key="filterLanguageTooltip">Usa c√≥digos ISO 639-1. Ej: 'ja' para japon√©s, 'es' para espa√±ol, 'ko' para coreano.</span></span>
                            </label>
                            <input type="text" id="language" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 transition-all" placeholder="Ej: ja, ko, es...">
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-700 pt-6 space-y-6">
                         <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-300"><span data-lang-key="filterYear">A√±o de Lanzamiento</span>: <span id="yearRangeLabel" class="text-purple-400 font-bold">1980 - 2025</span></label>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="range" id="startYear" min="1900" max="2025" value="1980" class="w-full range-slider"><input type="range" id="endYear" min="1900" max="2025" value="2025" class="w-full range-slider">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-300"><span data-lang-key="filterRating">Puntuaci√≥n</span>: <span id="ratingRangeLabel" class="text-purple-400 font-bold">7.0 - 10</span></label>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="range" id="startRating" min="0" max="10" step="0.1" value="7.0" class="w-full range-slider"><input type="range" id="endRating" min="0" max="10" step="0.1" value="10" class="w-full range-slider">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-300">
                                <span data-lang-key="filterVoteCount">Cantidad de Votos</span>
                                <span class="tooltip"><i class="fa-solid fa-circle-info text-gray-400"></i><span class="tooltiptext" data-lang-key="filterVoteCountTooltip">Usa un rango bajo para encontrar joyas ocultas, o un rango alto para encontrar cl√°sicos aclamados.</span></span>
                                : <span id="voteCountRangeLabel" class="text-purple-400 font-bold">100 - 1500</span>
                            </label>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="range" id="startVoteCount" min="0" max="10000" step="50" value="100" class="w-full range-slider"><input type="range" id="endVoteCount" min="0" max="10000" step="50" value="1500" class="w-full range-slider">
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row items-center justify-center gap-4 pt-4">
                        <button type="button" id="hiddenGemsPreset" class="w-full md:w-auto bg-gradient-to-r from-yellow-500 to-orange-500 hover:opacity-90 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> <span data-lang-key="btnFindGems">Encontrar Joyas Ocultas</span>
                        </button>
                        <button type="submit" class="w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg">
                            <i class="fa-solid fa-search"></i> <span data-lang-key="btnSearch">Buscar</span>
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <main>
            <div id="statusContainer" class="text-center py-12"></div>
            <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS ---
            const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';

            // --- DICTIONARY FOR TRANSLATIONS ---
            const translations = {
                es: {
                    docTitle: "KinoArcana: Buscador de Joyas del Cine",
                    appTitle: "KinoArcana",
                    appSubtitle: "Descubre las obras maestras que el algoritmo olvid√≥.",
                    filterType: "Tipo",
                    filterTypeMovie: "üé• Pel√≠culas",
                    filterTypeTV: "üì∫ Series de TV",
                    filterGenre: "G√©nero",
                    filterGenreAll: "Todos",
                    filterSortBy: "Ordenar Por",
                    filterSortPopularity: "Popularidad",
                    filterSortRating: "Mejor Puntuaci√≥n",
                    filterSortNewest: "M√°s Recientes",
                    filterSortRevenue: "Mayores Ingresos",
                    filterSortVotes: "M√°s Votadas",
                    filterLanguage: "Idioma Original",
                    filterLanguageTooltip: "Usa c√≥digos ISO 639-1. Ej: 'ja' para japon√©s, 'es' para espa√±ol, 'ko' para coreano.",
                    filterYear: "A√±o de Lanzamiento",
                    filterRating: "Puntuaci√≥n",
                    filterVoteCount: "Cantidad de Votos",
                    filterVoteCountTooltip: "Usa un rango bajo para encontrar joyas ocultas, o un rango alto para encontrar cl√°sicos aclamados.",
                    btnFindGems: "Encontrar Joyas Ocultas",
                    btnSearch: "Buscar",
                    statusLoading: "Buscando el mejor contenido...",
                    statusNoResults: "No se encontraron resultados",
                    statusNoResultsSub: "Prueba con filtros m√°s amplios.",
                    statusError: "Ocurri√≥ un error",
                    statusErrorVercel: "Esta aplicaci√≥n es avanzada y debe publicarse en un servidor para funcionar. ¬°Sigue la gu√≠a de Vercel para ponerla en l√≠nea gratis!",
                    statusErrorGenres: "No se pudieron cargar los g√©neros. Aseg√∫rate de que el backend est√° funcionando y la API Key es correcta.",
                    statusErrorSearch: "Error al realizar la b√∫squeda:",
                    cardVotes: "votos"
                },
                en: {
                    docTitle: "KinoArcana: Hidden Gems Finder",
                    appTitle: "KinoArcana",
                    appSubtitle: "Discover the masterpieces the algorithm forgot.",
                    filterType: "Type",
                    filterTypeMovie: "üé• Movies",
                    filterTypeTV: "üì∫ TV Series",
                    filterGenre: "Genre",
                    filterGenreAll: "All",
                    filterSortBy: "Sort By",
                    filterSortPopularity: "Popularity",
                    filterSortRating: "Top Rated",
                    filterSortNewest: "Newest",
                    filterSortRevenue: "Highest Revenue",
                    filterSortVotes: "Most Voted",
                    filterLanguage: "Original Language",
                    filterLanguageTooltip: "Use ISO 639-1 codes. E.g., 'ja' for Japanese, 'en' for English, 'ko' for Korean.",
                    filterYear: "Release Year",
                    filterRating: "Rating",
                    filterVoteCount: "Vote Count",
                    filterVoteCountTooltip: "Use a low range to find hidden gems, or a high range to find acclaimed classics.",
                    btnFindGems: "Find Hidden Gems",
                    btnSearch: "Search",
                    statusLoading: "Searching for the best content...",
                    statusNoResults: "No results found",
                    statusNoResultsSub: "Try using broader filters.",
                    statusError: "An error occurred",
                    statusErrorVercel: "This is an advanced application and must be deployed to a server to work. Follow the Vercel guide to get it online for free!",
                    statusErrorGenres: "Could not load genres. Make sure the backend is running and the API Key is correct.",
                    statusErrorSearch: "Error during search:",
                    cardVotes: "votes"
                },
                fr: {
                    docTitle: "KinoArcana: Chercheur de P√©pites",
                    appTitle: "KinoArcana",
                    appSubtitle: "D√©couvrez les chefs-d'≈ìuvre que l'algorithme a oubli√©s.",
                    filterType: "Type",
                    filterTypeMovie: "üé• Films",
                    filterTypeTV: "üì∫ S√©ries TV",
                    filterGenre: "Genre",
                    filterGenreAll: "Tous",
                    filterSortBy: "Trier par",
                    filterSortPopularity: "Popularit√©",
                    filterSortRating: "Mieux not√©s",
                    filterSortNewest: "Plus r√©cents",
                    filterSortRevenue: "Revenus les plus √©lev√©s",
                    filterSortVotes: "Plus vot√©s",
                    filterLanguage: "Langue originale",
                    filterLanguageTooltip: "Utilisez les codes ISO 639-1. Ex: 'ja' pour japonais, 'fr' pour fran√ßais, 'ko' pour cor√©en.",
                    filterYear: "Ann√©e de sortie",
                    filterRating: "Note",
                    filterVoteCount: "Nombre de votes",
                    filterVoteCountTooltip: "Utilisez une plage basse pour trouver des p√©pites, ou une plage √©lev√©e pour les classiques.",
                    btnFindGems: "Trouver des P√©pites",
                    btnSearch: "Rechercher",
                    statusLoading: "Recherche du meilleur contenu...",
                    statusNoResults: "Aucun r√©sultat trouv√©",
                    statusNoResultsSub: "Essayez avec des filtres plus larges.",
                    statusError: "Une erreur est survenue",
                    statusErrorVercel: "Cette application avanc√©e doit √™tre d√©ploy√©e sur un serveur. Suivez le guide Vercel pour la mettre en ligne gratuitement !",
                    statusErrorGenres: "Impossible de charger les genres. V√©rifiez que le backend fonctionne et que la cl√© API est correcte.",
                    statusErrorSearch: "Erreur lors de la recherche :",
                    cardVotes: "votes"
                },
                de: {
                    docTitle: "KinoArcana: Finder f√ºr verborgene Sch√§tze",
                    appTitle: "KinoArcana",
                    appSubtitle: "Entdecke die Meisterwerke, die der Algorithmus vergessen hat.",
                    filterType: "Typ",
                    filterTypeMovie: "üé• Filme",
                    filterTypeTV: "üì∫ Fernsehserien",
                    filterGenre: "Genre",
                    filterGenreAll: "Alle",
                    filterSortBy: "Sortieren nach",
                    filterSortPopularity: "Popularit√§t",
                    filterSortRating: "Bestbewertet",
                    filterSortNewest: "Neueste",
                    filterSortRevenue: "H√∂chster Umsatz",
                    filterSortVotes: "Meistbewertet",
                    filterLanguage: "Originalsprache",
                    filterLanguageTooltip: "Verwenden Sie ISO 639-1-Codes. Z.B. 'ja' f√ºr Japanisch, 'de' f√ºr Deutsch, 'ko' f√ºr Koreanisch.",
                    filterYear: "Ver√∂ffentlichungsjahr",
                    filterRating: "Bewertung",
                    filterVoteCount: "Anzahl der Stimmen",
                    filterVoteCountTooltip: "Verwenden Sie einen niedrigen Bereich f√ºr verborgene Sch√§tze oder einen hohen Bereich f√ºr Klassiker.",
                    btnFindGems: "Sch√§tze finden",
                    btnSearch: "Suchen",
                    statusLoading: "Suche nach den besten Inhalten...",
                    statusNoResults: "Keine Ergebnisse gefunden",
                    statusNoResultsSub: "Versuchen Sie es mit breiteren Filtern.",
                    statusError: "Ein Fehler ist aufgetreten",
                    statusErrorVercel: "Diese Anwendung muss auf einem Server bereitgestellt werden. Folgen Sie der Vercel-Anleitung, um sie kostenlos online zu stellen!",
                    statusErrorGenres: "Genres konnten nicht geladen werden. Stellen Sie sicher, dass das Backend l√§uft und der API-Schl√ºssel korrekt ist.",
                    statusErrorSearch: "Fehler bei der Suche:",
                    cardVotes: "Stimmen"
                },
                pt: {
                    docTitle: "KinoArcana: Ca√ßador de Joias Escondidas",
                    appTitle: "KinoArcana",
                    appSubtitle: "Descubra as obras-primas que o algoritmo esqueceu.",
                    filterType: "Tipo",
                    filterTypeMovie: "üé• Filmes",
                    filterTypeTV: "üì∫ S√©ries de TV",
                    filterGenre: "G√™nero",
                    filterGenreAll: "Todos",
                    filterSortBy: "Ordenar por",
                    filterSortPopularity: "Popularidade",
                    filterSortRating: "Mais bem avaliados",
                    filterSortNewest: "Mais recentes",
                    filterSortRevenue: "Maior receita",
                    filterSortVotes: "Mais votados",
                    filterLanguage: "Idioma original",
                    filterLanguageTooltip: "Use c√≥digos ISO 639-1. Ex: 'ja' para japon√™s, 'pt' para portugu√™s, 'ko' para coreano.",
                    filterYear: "Ano de lan√ßamento",
                    filterRating: "Avalia√ß√£o",
                    filterVoteCount: "Contagem de votos",
                    filterVoteCountTooltip: "Use um intervalo baixo para encontrar joias escondidas ou um intervalo alto para cl√°ssicos.",
                    btnFindGems: "Encontrar Joias",
                    btnSearch: "Pesquisar",
                    statusLoading: "Procurando o melhor conte√∫do...",
                    statusNoResults: "Nenhum resultado encontrado",
                    statusNoResultsSub: "Tente usar filtros mais amplos.",
                    statusError: "Ocorreu um erro",
                    statusErrorVercel: "Esta aplica√ß√£o avan√ßada deve ser implantada em um servidor. Siga o guia Vercel para coloc√°-la online de gra√ßa!",
                    statusErrorGenres: "N√£o foi poss√≠vel carregar os g√™neros. Certifique-se de que o backend est√° funcionando e a chave da API est√° correta.",
                    statusErrorSearch: "Erro durante a pesquisa:",
                    cardVotes: "votos"
                }
            };
            
            let currentLang = 'es';

            // --- DOM ELEMENTS ---
            const dom = {
                html: document.documentElement,
                docTitle: document.title,
                languageSelector: document.getElementById('languageSelector'),
                filterForm: document.getElementById('filterForm'),
                contentType: document.getElementById('contentType'),
                genre: document.getElementById('genre'),
                sortBy: document.getElementById('sortBy'),
                language: document.getElementById('language'),
                startYear: document.getElementById('startYear'),
                endYear: document.getElementById('endYear'),
                yearRangeLabel: document.getElementById('yearRangeLabel'),
                startRating: document.getElementById('startRating'),
                endRating: document.getElementById('endRating'),
                ratingRangeLabel: document.getElementById('ratingRangeLabel'),
                startVoteCount: document.getElementById('startVoteCount'),
                endVoteCount: document.getElementById('endVoteCount'),
                voteCountRangeLabel: document.getElementById('voteCountRangeLabel'),
                hiddenGemsPresetBtn: document.getElementById('hiddenGemsPreset'),
                statusContainer: document.getElementById('statusContainer'),
                resultsGrid: document.getElementById('resultsGrid'),
            };

            // --- LANGUAGE FUNCTIONS ---
            const setLanguage = (lang) => {
                if (!translations[lang]) return;
                currentLang = lang;
                dom.html.lang = lang;
                document.title = translations[lang].docTitle;
                localStorage.setItem('kinoarcana-lang', lang);
                
                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.getAttribute('data-lang-key');
                    if (translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });
                // Reload genres in the new language
                loadGenres();
            };

            const getInitialLanguage = () => {
                const savedLang = localStorage.getItem('kinoarcana-lang');
                if (savedLang && translations[savedLang]) {
                    return savedLang;
                }
                const browserLang = navigator.language.split('-')[0];
                return translations[browserLang] ? browserLang : 'en';
            };

            // --- EVENT LISTENERS ---
            const setupEventListeners = () => {
                dom.languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));
                dom.filterForm.addEventListener('submit', handleSearch);
                dom.contentType.addEventListener('change', loadGenres);
                dom.hiddenGemsPresetBtn.addEventListener('click', applyHiddenGemsPreset);
                ['startYear', 'endYear'].forEach(id => document.getElementById(id).addEventListener('input', updateRangeLabel(dom.yearRangeLabel, dom.startYear, dom.endYear)));
                ['startRating', 'endRating'].forEach(id => document.getElementById(id).addEventListener('input', updateRangeLabel(dom.ratingRangeLabel, dom.startRating, dom.endRating, 1)));
                ['startVoteCount', 'endVoteCount'].forEach(id => document.getElementById(id).addEventListener('input', updateRangeLabel(dom.voteCountRangeLabel, dom.startVoteCount, dom.endVoteCount)));
            };

            // --- API & DATA HANDLING ---
            function isInvalidEnvironment() {
                const protocol = window.location.protocol;
                return protocol.startsWith('blob') || protocol.startsWith('file');
            }
            
            async function loadGenres() {
                if (isInvalidEnvironment()) {
                    updateStatus('error', translations[currentLang].statusErrorVercel);
                    Array.from(dom.filterForm.elements).forEach(el => el.disabled = true);
                    return;
                }

                const type = dom.contentType.value;
                try {
                    const langParam = `${currentLang}-${currentLang.toUpperCase()}`;
                    const response = await fetch(`/api/genres?contentType=${type}&language=${langParam}`);
                    if (!response.ok) throw new Error('Error al cargar g√©neros');
                    const data = await response.json();
                    
                    const allGenresOption = dom.genre.querySelector('option[value=""]');
                    dom.genre.innerHTML = '';
                    if(allGenresOption) dom.genre.appendChild(allGenresOption);

                    data.genres.forEach(genre => {
                        dom.genre.innerHTML += `<option value="${genre.id}">${genre.name}</option>`;
                    });
                } catch (error) {
                    console.error('Error cargando g√©neros:', error);
                    updateStatus('error', translations[currentLang].statusErrorGenres);
                }
            }
            
            async function handleSearch(e) {
                if (e) e.preventDefault();
                if (isInvalidEnvironment()) return;

                updateStatus('loading');
                
                const langParam = `${currentLang}-${currentLang.toUpperCase()}`;
                const params = new URLSearchParams({
                    contentType: dom.contentType.value,
                    sort_by: dom.sortBy.value,
                    'vote_average.gte': dom.startRating.value,
                    'vote_average.lte': dom.endRating.value,
                    'vote_count.gte': dom.startVoteCount.value,
                    'vote_count.lte': dom.endVoteCount.value,
                    language: langParam, 
                    include_adult: false,
                });

                if (dom.genre.value) params.append('with_genres', dom.genre.value);
                if (dom.language.value) params.append('with_original_language', dom.language.value.trim());

                const dateParamPrefix = dom.contentType.value === 'movie' ? 'primary_release_date' : 'first_air_date';
                params.append(`${dateParamPrefix}.gte`, `${dom.startYear.value}-01-01`);
                params.append(`${dateParamPrefix}.lte`, `${dom.endYear.value}-12-31`);

                try {
                    const response = await fetch(`/api/discover?${params}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.status_message || `Error del servidor: ${response.statusText}`);
                    }
                    const data = await response.json();
                    displayResults(data.results || []);
                } catch (error) {
                    console.error('Error en b√∫squeda:', error);
                    updateStatus('error', `${translations[currentLang].statusErrorSearch} ${error.message}`);
                }
            }
            
            // --- UI & DISPLAY ---
            const updateRangeLabel = (labelElem, startElem, endElem, decimals = 0) => () => {
                let start = parseFloat(startElem.value);
                let end = parseFloat(endElem.value);
                if (start > end) {
                    [start, end] = [end, start];
                    startElem.value = start;
                    endElem.value = end;
                }
                labelElem.textContent = `${start.toFixed(decimals)} - ${end.toFixed(decimals)}`;
            };
            
            const updateStatus = (type, message = '', subMessage = '') => {
                dom.resultsGrid.innerHTML = '';
                let content = '';
                const lang = translations[currentLang];
                switch (type) {
                    case 'loading': content = `<div class="spinner mx-auto"></div><p class="mt-4 text-gray-300">${lang.statusLoading}</p>`; break;
                    case 'no-results': content = `<div class="text-6xl mb-4">ü§∑</div><h3 class="text-xl font-semibold">${lang.statusNoResults}</h3><p class="text-gray-300">${lang.statusNoResultsSub}</p>`; break;
                    case 'error': content = `<div class="text-6xl mb-4">‚ö†Ô∏è</div><h3 class="text-xl font-semibold">${lang.statusError}</h3><p class="text-gray-300">${message}</p>`; break;
                }
                dom.statusContainer.innerHTML = content;
            };

            const displayResults = (results) => {
                dom.statusContainer.innerHTML = '';
                if (results.length === 0) return updateStatus('no-results');
                results.forEach(item => {
                    const card = createResultCard(item);
                    dom.resultsGrid.appendChild(card);
                });
            };

            const createResultCard = (item) => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg card-hover animate-fade-in';
                const title = item.title || item.name;
                const year = (item.release_date || item.first_air_date || 'N/A').split('-')[0];
                const posterPath = item.poster_path ? `${IMAGE_BASE_URL}${item.poster_path}` : 'https://placehold.co/500x750/1f2937/4b5563?text=No+Image';

                card.innerHTML = `
                    <div class="relative aspect-[2/3] bg-gray-700">
                        <img src="${posterPath}" alt="${title}" class="w-full h-full object-cover" loading="lazy">
                        <div class="absolute top-2 right-2 bg-black bg-opacity-70 px-2 py-1 rounded-full flex items-center text-xs">
                            <i class="fa-solid fa-star text-yellow-400 mr-1"></i>
                            <span class="font-bold">${item.vote_average.toFixed(1)}</span>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-white mb-1 line-clamp-2">${title}</h3>
                        <div class="text-gray-400 text-sm flex justify-between items-center">
                            <span>${year}</span>
                            <span class="flex items-center" title="${item.vote_count} ${translations[currentLang].cardVotes}">
                                <i class="fa-solid fa-users mr-1"></i>
                                ${item.vote_count}
                            </span>
                        </div>
                    </div>`;
                return card;
            };
            
            const applyHiddenGemsPreset = () => {
                dom.sortBy.value = 'vote_average.desc';
                dom.startRating.value = 7.5;
                dom.endRating.value = 10;
                dom.startVoteCount.value = 50;
                dom.endVoteCount.value = 1500;
                
                updateRangeLabel(dom.ratingRangeLabel, dom.startRating, dom.endRating, 1)();
                updateRangeLabel(dom.voteCountRangeLabel, dom.startVoteCount, dom.endVoteCount)();
                
                handleSearch();
            };

            // --- INITIALIZATION ---
            const initLang = getInitialLanguage();
            dom.languageSelector.value = initLang;
            setLanguage(initLang);
            setupEventListeners();
            updateRangeLabel(dom.yearRangeLabel, dom.startYear, dom.endYear)();
            updateRangeLabel(dom.ratingRangeLabel, dom.startRating, dom.endRating, 1)();
            updateRangeLabel(dom.voteCountRangeLabel, dom.startVoteCount, dom.endVoteCount)();
        });
    </script>
</body>
</html>


